<html>
<head>
<title>INFO 3300 - Data-driven Web Applications</title>
<link href="https://fonts.googleapis.com/css?family=Barlow+Condensed" rel="stylesheet">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css">
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
<style>
body { font-family: 'Barlow Condensed', Calibri, sans-serif; }
path.country { fill: #000; stroke: #ffffff; }

/* Gradient styling*/
.stop-left {
    stop-color: #0099ff;  /* blue */
}

.stop-right {
    stop-color: #ff3300;  /* maroon */
}

.filled {
    fill: url(#mainGradient);
}

.outlined {
    fill:   none;
    stroke: url(#mainGradient);
    stroke-width: 4;
}

a {
    color: #0099ff;
}

a:hover {
    color: #ff3300;
}

</style>
</head>
<body>
<!-- <h3 align="center" style="margin-bottom:0px;margin-top:10px; font-size:40px">Who Produces the World's Best Chocolates?</h3> -->

<svg id="barPlot" height="1000" width="350" style="float:left"></svg> 
<svg id="map" height="750" width="850" style="float:center"></svg>  <!-- 400 900 -->

<p>
Experts judged these chocolate bars from unpleasant (1) to elite (5) using a variety of criteria such as
flavor, texture, and aftermelt. We then took this data and matched the home country of the companies that 
produced the chocolate to the average rating that each chocolate received from the experts. 
</p>
<p>
<b>Source:</b> <a href="https://www.kaggle.com/rtatman/chocolate-bar-ratings">Kaggle's chocolate bar ratings dataset.</a>
</p>
<script>
var mapData;
var chocolateData;
var countryScores = {};
var countryAverages = {};
var countryPercentages = {}; // total percent cocoa by country
var countryPercentageAvgs = {}; // average percent cocoa by country
var rankData = [];
var saleDataArr = {};
var salesData;
var barSvg = d3.select("#barPlot");
var mapSvg = d3.select("#map");


// used for drawing countries
var paths;
var projection = d3.geoMercator().scale(125);
var pathGenerator = d3.geoPath().projection(projection);
var sequentialColors = ['#0099ff', '#ff3300']; //[worst, best]
var mapScale = d3.scaleLinear()
.domain([2.5,3.75]) //(min-.5,max)
.range(sequentialColors);

d3.queue()
.defer(d3.json, "countries.geo.json")
.defer(d3.csv, "flavors_of_cacao.csv")
.defer(d3.csv, "chocSales.csv")
.await(callback);

function callback(error, rawMap, rawChocolate ,rawSales) {
    if (error) {
        console.log(error);
    }
    chocolateData = rawChocolate;
    salesData = rawSales;
    mapData = rawMap.features;
    projection.fitExtent([[0,0], [mapSvg.attr("width"), mapSvg.attr("height")]], rawMap);

    // create countryScores: maps each country to array of scores
    for (i = 0; i < chocolateData.length; i++) {
        var country = chocolateData[i]["Company\nLocation"];
        if (!(country in countryScores)) {
            countryScores[country] = [];
            countryPercentages[country] = [];
        }
        countryScores[country].push(chocolateData[i]["Rating"]);
        countryPercentages[country].push(parseFloat(chocolateData[i]["Cocoa\nPercent"])/100);
    }
    // create countryAverages: maps each country to average score
    for (var key in countryScores) {
        var ratingsArray = countryScores[key];
        var average = 0;
        for(var i = 0; i < ratingsArray.length; i++) {
            average += parseFloat(ratingsArray[i]);
        }
        average /= ratingsArray.length;
        countryAverages[key] = average;
    }
    // create countryPercentAvgs: maps each country to average % cocoa
    for (var key in countryPercentages) {
        var sum = countryPercentages[key].reduce(function (a, b) { return a + b; });
        countryPercentageAvgs[key] = (sum / countryPercentages[key].length).toFixed(4); // round to 4 decimal places
    }

    displayChocolate();
    displayMap();
}

// display and color in map countries with scales
function displayMap() {
    paths = mapSvg.selectAll("path.country")
    .data(mapData);

    paths = paths.enter().append("path")
    .attr("class", "country").merge(paths);

    paths
    .style("fill", function (country) {
        var average = countryAverages[country.properties.name];
        if (average) {
            return mapScale(Math.pow(average,1));
        }
    })
    .attr("d", function (country) {
        return pathGenerator(country);
    })
    .attr("transform", "translate(0, 50)");

    mapSvg.append("text")
    .attr("text-anchor", "middle")
    .attr("transform", "translate(500, 50)")
    .attr("text-align", "center")
    .attr("font-size", 40)
    .attr("font-weight", "bold")
    .text(function (t) { return "Who Produces the World's Best Chocolates?" });

    mapSvg.append("text")
    .attr("text-anchor", "middle")
    .attr("transform", "translate(500, 80)")
    .attr("font-size", 20)
    .text(function (t) { return "A visualization of experts' ratings of 1,700 chocolate bars from 60 countries" });
}

function displayChocolate() {

/* var svgBar = d3.select("body").append("svg")
.attr("width", 300)
.attr("height", 800)
.style("border","none"); */

	var barHeight = 15;

	var legendW = 100;
	var legendH = 20;

	var rateColor = "#2A7F31";
	var beanColor = "#819fae";



    //console.log(data); 
    var exporter = "";
    //sales data
	for (i = 0; i < salesData.length; i++) {
		var exporter = salesData[i]["Exporter"];    
		saleDataArr[exporter] = parseFloat(salesData[i][" Percent_Total"]);
	}

	salesColor = "#bfbfbf";

   // get rankData from countryAverages

	for(var key in countryAverages){
		if(key in saleDataArr){
			rankData.push({rating:countryAverages[key],country:key,salesPerc:saleDataArr[key]});
		}else{
			rankData.push({rating:countryAverages[key],country:key,salesPerc:0});
		}  

	}

	rankData.sort(function(a, b) {
	return b.rating - a.rating;
	});

 


//rankData = rankData.slice(0,50);

	var rankExtent = d3.extent(rankData, function (d) { return d.rating; });
	rankScale = d3.scaleLinear()
	.domain(rankExtent)
	.range([30, 170]);

	var saleExtent = d3.extent(rankData, function (d) { return d.salesPerc; });
	saleScale = d3.scaleLinear()
	.domain(saleExtent)
	.range([30, 170]); 



	//------- legend ---------
	//color scale
	var defs = barSvg.append("defs");
	var mainGradient = defs.append('linearGradient')
	.attr('id', 'mainGradient');

	//create stops for colors
	mainGradient.append('stop')
	.attr('class', 'stop-left')
	.attr('offset', '0');

	mainGradient.append('stop')
	.attr('class', 'stop-right')
	.attr('offset', '1');


	//rating
	barSvg.append("rect")
	.classed('filled', true)
	.attr("width", legendW)
	.attr("height", legendH) //adjust spacing b/w bars
	.attr("x", 0)
	.attr("y", 20);

	barSvg.append("text")
	.attr("x", 5+legendW )
	.attr("y", 20+legendH/2)
	.attr("dy", ".35em")
	.style("font-size","16px")
	.text("5 POINT RATING");

	barSvg.append("text")
	.attr("x", 0 )
	.attr("y", legendH/2)
	.attr("dy", ".35em")
	.style("font-size","16px")
	.text("Worst");

	barSvg.append("text")
	.attr("x", legendW-25)
	.attr("y", legendH/2)
	.attr("dy", ".35em")
	.style("font-size","16px")
	.text("Best");
	//-----------------------------


	    //bean count
	/* barSvg.append("rect")
	.attr("width", legendW)
	.attr("height", legendH) //adjust spacing b/w bars
	.attr("x", 10*legendW)
	.attr("y", 0)
	.style("fill",beanColor);

	svgBar.append("text")
	.attr("x", 10*legendW+legendW+2)
	.attr("y", legendH/2)
	.attr("dy", ".35em")
	.style("font-size","12px")
	.text("Bean-blend Types Produced"); */

	//make sure all bars begin at different y
	var bar = barSvg.selectAll("g")
	.data(rankData)
	.enter().append("g")
	.attr("transform", function(d, i) { return "translate(0," + (i+3) * barHeight + ")"; });


	//-------- append bars and their values -----------
	bar.append("rect")
	.attr("width", function(d) { return rankScale(d.rating); })
	.attr("height", barHeight - 3) //adjust spacing b/w bars
	.style("fill",function(d) { return mapScale(Math.pow(d.rating,1)); });

	//sales bars
	bar.append("rect")
	.attr("width", function(d) { return saleScale(d.salesPerc); })
	.attr("height", barHeight - 3) //adjust spacing b/w bars
	.attr("transform",function(d) { return "translate("+rankScale(d.rating)+",0)";})
	.style("fill",function(d) { return mapScale(Math.pow(d.rating,1)); })
	.style("opacity",0.6); 

	//append name at end
	bar.append("text")
	.attr("x", function(d) { return rankScale(d.rating)+saleScale(d.salesPerc)+15; }) //return countScale(d.count)+rankScale(d.rank)+15;
	.attr("y", barHeight / 2)
	.attr("dy", ".35em")
	.style("font-size","14px")
	.text(function(d) { return d.country; });

	//first bar rating text
	bar.append("text")
	.attr("x", 5)
	.attr("y", barHeight / 2)
	.attr("dy", ".35em")
	.style("fill","white")
	.style("font-size","13px")
	.text(function(d) { return d.rating.toFixed(2); }); //only display to 2 decimal places

	//2nd bar text, sales %
	bar.append("text")
	.attr("x", function(d) { return rankScale(d.rating)+saleScale(d.salesPerc)-25; })
	.attr("y", barHeight/2 - 1)
	.attr("dy", ".35em")
	.style("fill","white")
	.style("font-size","13px")
	.text(function(d) { return d.salesPerc+"%"; }); 




}

</script>


</body>
</html>
