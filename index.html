<html>
<head>
<title>INFO 3300 - Data-driven Web Applications</title>
<link href="https://fonts.googleapis.com/css?family=Alegreya|Alegreya+Sans" rel="stylesheet">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css">
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
<style>
path.country { fill: #ccc; stroke: #888;; }
</style>
</head>
<body>
<svg height="400" width="900"></svg> 
<!-- change this to make it look nicer later -->
<script>
var mapData;
var chocolateData;
var countryScores = {};
var countryAverages = {};
var averageValues = [];
var svg = d3.select("svg");

// used for drawing countries
var paths;
var countries; 
var projection = d3.geoEquirectangular().scale(150);
var pathGenerator = d3.geoPath().projection(projection);
var sequentialColors = ['#ffffff', '#2A7F31'];
var mapScale = d3.scaleLinear()
.domain([1,5])
.range(sequentialColors);

d3.queue()
.defer(d3.json, "countries.geo.json")
.defer(d3.csv, "flavors_of_cacao.csv")
.await(callback);

function callback(error, rawMap, rawChocolate) {
    if (error) {
        console.log(error);
    }
    chocolateData = rawChocolate;
    
    mapData = rawMap.features;
    projection.fitExtent([[0,0], [svg.attr("width"), svg.attr("height")]], rawMap);

    // create countryScores: maps each country to array of scores
    for (i = 0; i < chocolateData.length; i++) {
        var country = chocolateData[i]["Company\nLocation"];
        if (!(country in countryScores)) {
            countryScores[country] = [];
        }
        countryScores[country].push(chocolateData[i]["Rating"]);
    }
    // create countryAverages: maps each country to average score
    for (var key in countryScores) {
        var ratingsArray = countryScores[key];
        var average = 0;
        for(var i = 0; i < ratingsArray.length; i++) {
            average += parseFloat(ratingsArray[i]);
        }
        average /= ratingsArray.length;
        countryAverages[key] = average;
    }

    Object.keys(countryAverages).map(function (v, i) {
        averageValues.push(Number(countryAverages[v]));
    });

    displayChocolate();
    displayMap();
}

// display and color in map countries with scales
function displayMap() {
    paths = svg.selectAll("path.country")
    .data(mapData);

    paths = paths.enter().append("path")
    .attr("class", "country").merge(paths);

    paths
    .style("fill", function (country) {
        var average = countryAverages[country.properties.name];
        if (average) {
            return mapScale(average);
        }
    })
    .attr("d", function (country) {
        return pathGenerator(country);
    });
}

function displayChocolate() {

}

</script>
</body>
</html>